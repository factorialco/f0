name: Code Quality checks
on:
  pull_request:
    branches: [main]
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
jobs:
  # Detect which projects have changed
  detect-changes:
    uses: ./.github/workflows/_check-workspaces-changes.yaml
  prettier:
    needs: detect-changes
    # Prevents running on the release-please branch
    if: |
      needs.detect-changes.outputs.package_react == 'true' &&
      github.head_ref != 'release-please--branches--master' &&
      !contains(github.event.pull_request.labels.*.name, 'autorelease')
    name: Prettier
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-pnpm
      - name: Check formatting with Prettier
        run: pnpm --filter @factorialco/f0-react run prettier:check:ci
  eslint:
    needs: detect-changes
    # Prevents running on the release-please branch
    if: |
      needs.detect-changes.outputs.package_react == 'true' &&
      github.head_ref != 'release-please--branches--master' &&
      !contains(github.event.pull_request.labels.*.name, 'autorelease')
    name: "[âš›ï¸ REACT] Eslint"
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
      - uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: "22.x"
          cache: pnpm
      - name: Install dependencies
        run: pnpm install
      - name: Build core package
        run: pnpm --filter @factorialco/f0-core build
      - name: Check linting with eslint
        run: pnpm --filter @factorialco/f0-react run lint
  eslint-react-native:
    needs: detect-changes
    # Prevents running on the release-please branch
    if: |
      needs.detect-changes.outputs.package_react_native == 'true'
    name: "[ðŸ“± REACT NATIVE] Eslint"
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
      - uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: "22.x"
          cache: pnpm
      - name: Install dependencies
        run: pnpm install
      - name: Build core package
        run: pnpm --filter @factorialco/f0-core build
      - name: Check linting with eslint
        run: pnpm --filter @factorialco/f0-react-native run lint
      - name: Check typescript
        run: pnpm --filter @factorialco/f0-react-native exec tsc --noEmit
  cycle-dependencies:
    needs: detect-changes
    # Prevents running on the release-please branch
    if: |
      needs.detect-changes.outputs.package_react == 'true' &&
      github.head_ref != 'release-please--branches--master' &&
      !contains(github.event.pull_request.labels.*.name, 'autorelease')
    name: "[âš›ï¸ REACT] Cycle Dependencies Check"
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
      - uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: "22.x"
          cache: pnpm
      - name: Install dependencies
        run: pnpm install
      - name: Build core package
        run: pnpm --filter @factorialco/f0-core build
      - name: Get latest commit from main
        id: main-commit
        run: |
          git fetch origin main:main || true
          MAIN_COMMIT=$(git rev-parse origin/main 2>/dev/null || git rev-parse main)
          echo "commit=$MAIN_COMMIT" >> $GITHUB_OUTPUT
          echo "Main branch commit: $MAIN_COMMIT"
      - name: Detect cycle dependencies and compare
        id: compare
        continue-on-error: true
        run: |
          cd packages/react

          # Run the script and capture JSON output
          # The script may exit with 1 if new cycles are found, so we use continue-on-error
          SCRIPT_OUTPUT=$(pnpm exec tsx .scripts/check-cycle-dependencies.ts --ci --compare-commit ${{ steps.main-commit.outputs.commit }} 2>&1 || true)

          # Export the output as an environment variable for the Node.js script
          export SCRIPT_OUTPUT

          # Parse JSON and set outputs
          node << 'NODE_SCRIPT'
          const output = process.env.SCRIPT_OUTPUT || '';

          // Extract JSON from output (it should be the last line or a standalone JSON block)
          const lines = output.trim().split('\n');
          let jsonLine = '';

          // Find the JSON line (starts with {)
          for (let i = lines.length - 1; i >= 0; i--) {
            const line = lines[i].trim();
            if (line.startsWith('{')) {
              jsonLine = line;
              break;
            }
          }

          // If no JSON found, try parsing the entire output
          if (!jsonLine) {
            jsonLine = output.trim();
          }

          if (!jsonLine) {
            console.log('new_cycles_found=false');
            process.exit(0);
          }

          try {
            const data = JSON.parse(jsonLine);
            const hasNewCycles = data.hasNewCycles === true;
            
            console.log(`new_cycles_found=${hasNewCycles}`);
            
            if (hasNewCycles && data.newCycles && data.newCycles.cyclesList && data.newCycles.cyclesList.length > 0) {
              const newCyclesText = data.newCycles.cyclesList
                .map((cycle) => `  ${cycle.cycle}`)
                .join('\n');
              
              console.log('new_cycles<<CYCLES_EOF');
              console.log(newCyclesText);
              console.log('CYCLES_EOF');
            }
          } catch (error) {
            console.error('Error parsing JSON:', error.message);
            console.error('Attempted to parse:', jsonLine.substring(0, 200));
            console.log('new_cycles_found=false');
            process.exit(1);
          }
          NODE_SCRIPT
      - name: Comment on PR with new cycles
        uses: ./.github/actions/add-or-update-pr-comment
        with:
          comment-type: cycle_dependency
          condition: ${{ steps.compare.outputs.new_cycles_found == 'true' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-body: |
            ## âš ï¸ New Circular Dependencies Detected

            The following new circular dependencies have been detected:

            ```
            ${{ steps.compare.outputs.new_cycles }}
            ```

            Please review and resolve these circular dependencies.
