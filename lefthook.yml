# Validate commit messages
commit-msg:
  commands:
    "lint commit message":
      run: pnpm exec commitlint --edit {1}
pre-commit:
  commands:
    format:
      glob: "**/*.{js,jsx,ts,tsx,json,css,md,yml,yaml,md}"
      run: pnpm exec prettier {staged_files} --write
      stage_fixed: true
    cycle-dependencies:
      run: |
        # Get modified TypeScript/TSX files
        MODIFIED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | grep '^packages/react/' || true)
        
        if [ -z "$MODIFIED_FILES" ]; then
          echo "No React package files modified, skipping cycle dependency check"
          exit 0
        fi
        
        # Get current HEAD SHA
        HEAD_SHA=$(git rev-parse HEAD)
        CACHE_DIR=".cache"
        BASELINE_FILE="$CACHE_DIR/cycle-dependencies-$HEAD_SHA.json"
        
        # Create cache directory if it doesn't exist
        mkdir -p "$CACHE_DIR"
        
        # Clean up cache files older than 1 month
        find "$CACHE_DIR" -name "cycle-dependencies-*.json" -type f -mtime +30 -delete 2>/dev/null || true
        
        # Check if baseline exists for current HEAD
        if [ ! -f "$BASELINE_FILE" ]; then
          echo "No baseline found for HEAD ($HEAD_SHA), creating baseline..."
          cd packages/react
          npx dpdm --circular --no-tree --no-warning src/f0.ts > "../../$BASELINE_FILE" 2>&1 || true
          cd ../..
          
          # Normalize baseline (remove empty lines, sort)
          if [ -s "$BASELINE_FILE" ]; then
            sort "$BASELINE_FILE" | grep -v '^$' > "${BASELINE_FILE}.tmp"
            mv "${BASELINE_FILE}.tmp" "$BASELINE_FILE"
          else
            touch "$BASELINE_FILE"
          fi
        fi
        
        # Run dpdm on current state
        CURRENT_OUTPUT=$(mktemp)
        cd packages/react
        npx dpdm --circular --no-tree --no-warning src/f0.ts > "$CURRENT_OUTPUT" 2>&1 || true
        cd ../..
        
        # Normalize current output
        CURRENT_NORMALIZED=$(mktemp)
        if [ -s "$CURRENT_OUTPUT" ]; then
          sort "$CURRENT_OUTPUT" | grep -v '^$' > "$CURRENT_NORMALIZED"
        else
          touch "$CURRENT_NORMALIZED"
        fi
        
        # Compare with baseline
        NEW_CYCLES=$(comm -13 <(sort "$BASELINE_FILE") <(sort "$CURRENT_NORMALIZED") 2>/dev/null || cat "$CURRENT_NORMALIZED")
        
        if [ -n "$NEW_CYCLES" ] && [ -s "$CURRENT_NORMALIZED" ]; then
          echo "❌ New circular dependencies detected:"
          echo ""
          echo "$NEW_CYCLES"
          echo ""
          echo "Please resolve these circular dependencies before committing."
          rm -f "$CURRENT_OUTPUT" "$CURRENT_NORMALIZED"
          exit 1
        else
          echo "✅ No new circular dependencies detected"
          rm -f "$CURRENT_OUTPUT" "$CURRENT_NORMALIZED"
          exit 0
        fi
